MODx.grid.LocalProperty=function(config){config=config||{};Ext.applyIf(config,{dynProperty:'xtype',dynField:'value',propertyRecord:[{name:'name'},{name:'value'}],data:[]});MODx.grid.LocalProperty.superclass.constructor.call(this,config);this.propRecord=Ext.data.Record.create(config.propertyRecord);};Ext.extend(MODx.grid.LocalProperty,MODx.grid.LocalGrid,{onCellDblClick:function(g,ri,ci,e){var cm=this.getColumnModel();if(cm.getColumnId(ci)==this.config.dynField){e.preventDefault();var r=this.getStore().getAt(ri).data;this.initEditor(cm,ci,ri,r);this.startEditing(ri,ci);}},initEditor:function(cm,ci,ri,r){cm.setEditable(ci,true);var xtype=this.config.dynProperty;var o;if(r[xtype]=='list'){o=this.createCombo(r);}else{var z={};z[xtype]=r[xtype]||'textfield';try{o=Ext.ComponentMgr.create(z);}catch(e){z[xtype]='textfield';o=MODx.load(z);}}
var ed=new Ext.grid.GridEditor(o);cm.setEditor(ci,ed);return ed;},renderDynField:function(v,md,rec,ri,ci,s,g){var r=s.getAt(ri).data;var f,idx;var oz=v;var xtype=this.config.dynProperty;if(!r[xtype]||r[xtype]=='combo-boolean'){f=MODx.grid.Grid.prototype.rendYesNo;oz=f(v==1,md);}else if(r[xtype]==='datefield'){f=Ext.util.Format.dateRenderer('Y-m-d');oz=f(v);}else if(r[xtype]==='password'){f=this.rendPassword;oz=f(v,md);}else if(r[xtype].substr(0,5)=='combo'||r[xtype]=='list'||r[xtype].substr(0,9)=='modx-combo'){var cm=g.getColumnModel();var ed=cm.getCellEditor(ci,ri);var cb;if(!ed){r.xtype=r.xtype||'combo-boolean';cb=this.createCombo(r);ed=new Ext.grid.GridEditor(cb);cm.setEditor(ci,ed);}else if(ed&&ed.field&&ed.field.xtype=='modx-combo'){cb=ed.field;}
if(r[xtype]!='list'){f=Ext.util.Format.comboRenderer(ed.field);oz=f(v);}else if(cb){idx=cb.getStore().find(cb.valueField,v);rec=cb.getStore().getAt(idx);if(rec){oz=rec.get(cb.displayField);}else{oz=v;}}}
return Ext.util.Format.htmlEncode(oz);},createCombo:function(p){var obj;try{obj=Ext.ComponentMgr.create({xtype:r.xtype,id:Ext.id()});}catch(e){try{var flds=p.options;var data=[];for(var i=0;i<flds.length;i=i+1){data.push([flds[i].name,flds[i].value,flds[i].text]);}
obj=MODx.load({xtype:'modx-combo',store:new Ext.data.SimpleStore({fields:['d','v','t'],data:data}),displayField:'d',valueField:'v',mode:'local',triggerAction:'all',editable:false,selectOnFocus:false,preventRender:true});}catch(e2){obj=Ext.ComponentMgr.create({xtype:'combo-boolean',id:Ext.id()});}}
return obj;}});Ext.reg('grid-local-property',MODx.grid.LocalProperty);;MODx.grid.SourceProperties=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="modx-property-description"><i>{desc_trans}</i></p>')});Ext.applyIf(config,{title:_('properties'),id:'modx-grid-source-properties',maxHeight:300,fields:['name','desc','xtype','options','value','lexicon','overridden','desc_trans'],autoExpandColumn:'value',sortBy:'name',width:'100%',sm:new Ext.grid.RowSelectionModel({singleSelect:false}),loadMask:true,lockProperties:true,panel:'modx-panel-source',plugins:[this.exp],columns:[this.exp,{header:_('name'),dataIndex:'name',width:200,sortable:true,renderer:this._renderName},{header:_('type'),dataIndex:'xtype',width:100,renderer:this._renderType,sortable:true},{header:_('value'),dataIndex:'value',id:'value',width:250,renderer:this.renderDynField.createDelegate(this,[this],true),sortable:true}],tbar:[{text:_('property_create'),id:'modx-btn-property-create',cls:'primary-button',handler:this.create,scope:this},{text:_('property_revert_all'),id:'modx-btn-property-revert-all',handler:this.revertAll,scope:this}],collapseFirst:false,tools:[{id:'plus',qtip:_('expand_all'),handler:this.expandAll,scope:this},{id:'minus',hidden:true,qtip:_('collapse_all'),handler:this.collapseAll,scope:this}]});MODx.grid.SourceProperties.superclass.constructor.call(this,config);this.on('afteredit',this.propertyChanged,this);this.on('afterRemoveRow',this.propertyChanged,this);this.on('celldblclick',this.onDirty,this);this.on('render',function(){this.mask=new Ext.LoadMask(this.getEl());},this);};Ext.extend(MODx.grid.SourceProperties,MODx.grid.LocalProperty,{defaultProperties:[],onDirty:function(){if(this.config.panel){Ext.getCmp(this.config.panel).fireEvent('fieldChange');}},_renderType:function(v,md,rec,ri){switch(v){case'combo-boolean':return _('yesno');break;case'datefield':return _('date');break;case'numberfield':return _('integer');break;}
return _(v);},_renderName:function(v,md,rec,ri){switch(rec.data.overridden){case 1:return'<span style="color: green;">'+v+'</span>';break;case 2:return'<span style="color: purple;">'+v+'</span>';default:return'<span>'+v+'</span>';}},create:function(btn,e){this.loadWindow(btn,e,{xtype:'modx-window-source-property-create',blankValues:true,listeners:{'success':{fn:function(r){var rec=new this.propRecord({name:r.name,desc:r.desc,desc_trans:r.desc,xtype:r.xtype,options:r.options,value:r.value,lexicon:r.lexicon,overridden:2});this.getStore().add(rec);this.propertyChanged();this.onDirty();},scope:this}}});},update:function(btn,e){this.loadWindow(btn,e,{xtype:'modx-window-source-property-update',record:this.menu.record,listeners:{'success':{fn:function(r){var s=this.getStore();var ri=this.menu.recordIndex;var d=this.defaultProperties[ri];d=(d&&d[4])?d[4]:r.value;var rec=s.getAt(this.menu.recordIndex);rec.set('name',r.name);rec.set('desc',r.desc);rec.set('desc_trans',r.desc);rec.set('xtype',r.xtype);rec.set('options',r.options);rec.set('value',r.value);rec.set('lexicon',r.lexicon);rec.set('overridden',r.overridden==2?2:(d.toString()==r.value.toString()?0:1));this.getView().refresh();this.onDirty();},scope:this}}});},revert:function(btn,e){Ext.Msg.confirm(_('warning'),_('property_revert_confirm'),function(e){if(e=='yes'){var ri=this.menu.recordIndex;var d=this.defaultProperties[ri];if(d){var rec=this.getStore().getAt(ri);rec.set('name',d[0]);rec.set('desc',d[1]);rec.set('xtype',d[2]);rec.set('options',d[3]);rec.set('value',d[4]);rec.set('overridden',0);rec.commit();}}},this);},revertAll:function(btn,e){Ext.Msg.confirm(_('warning'),_('property_revert_all_confirm'),function(e){if(e=='yes'){this.getStore().loadData(this.defaultProperties);}},this);},removeMultiple:function(btn,e){var rows=this.getSelectionModel().getSelections();var rids=[];for(var i=0;i<rows.length;i=i+1){rids.push(rows[i].data.id);}
Ext.Msg.confirm(_('warning'),_('properties_remove_confirm'),function(e){if(e=='yes'){for(var f=0;f<rows.length;f=f+1){this.store.remove(rows[f]);}}},this);},_showMenu:function(g,ri,e){var sm=this.getSelectionModel();if(sm.getSelections().length>1){e.stopEvent();e.preventDefault();this.menu.removeAll();this.addContextMenuItem([{text:_('properties_remove'),handler:this.removeMultiple,scope:this}]);this.menu.show(e.target);}else{MODx.grid.SourceProperties.superclass._showMenu.call(this,g,ri,e);}},getMenu:function(){var def=false;var r=this.menu.record;var m=[]
m.push({text:_('property_update'),scope:this,handler:this.update});if(r.overridden){m.push({text:_('property_revert'),scope:this,handler:this.revert});}
if(r.overridden!=1){m.push({text:_('property_remove'),scope:this,handler:this.remove.createDelegate(this,[{title:_('warning'),text:_('property_remove_confirm')}])});}
return m;},propertyChanged:function(){var ep=Ext.getCmp(this.config.panel);if(!ep)return false;var hf=ep.getForm().findField((this.config.hiddenPropField||'props'));if(hf){hf.setValue('1');ep.fireEvent('fieldChange',{field:hf,form:ep.getForm()});}
return true;}});Ext.reg('modx-grid-source-properties',MODx.grid.SourceProperties);MODx.grid.SourcePropertyOption=function(config){config=config||{};Ext.applyIf(config,{title:_('property_options'),id:'modx-grid-source-property-options',autoHeight:true,maxHeight:300,width:'100%',fields:['text','value','name'],data:[],columns:[{header:_('name'),dataIndex:'text',width:150,editor:{xtype:'textfield',allowBlank:false}},{header:_('value'),dataIndex:'value',id:'value',width:250,editor:{xtype:'textfield',allowBlank:true}}],tbar:[{text:_('property_option_create'),cls:'primary-button',handler:this.create,scope:this}]});MODx.grid.SourcePropertyOption.superclass.constructor.call(this,config);this.optRecord=Ext.data.Record.create([{name:'text'},{name:'value'}]);};Ext.extend(MODx.grid.SourcePropertyOption,MODx.grid.LocalGrid,{create:function(btn,e){this.loadWindow(btn,e,{xtype:'modx-window-source-property-option-create',listeners:{'success':{fn:function(r){var rec=new this.optRecord({text:r.text,value:r.value});this.getStore().add(rec);},scope:this}}});},getMenu:function(){return[{text:_('property_option_remove'),scope:this,handler:this.remove.createDelegate(this,[{title:_('warning'),text:_('property_option_remove_confirm')}])}];}});Ext.reg('modx-grid-source-property-options',MODx.grid.SourcePropertyOption);MODx.window.CreateSourceProperty=function(config){config=config||{};Ext.applyIf(config,{title:_('property_create'),id:'modx-window-source-property-create',saveBtnText:_('done'),fields:[{fieldLabel:_('name'),name:'name',id:'modx-cep-name',xtype:'textfield',anchor:'100%',allowBlank:false},{fieldLabel:_('description'),name:'desc',id:'modx-cep-desc',xtype:'textarea',anchor:'100%'},{fieldLabel:_('type'),name:'xtype',id:'modx-cep-xtype',xtype:'modx-combo-xtype',anchor:'100%',listeners:{'select':{fn:function(cb,r,i){var g=Ext.getCmp('modx-cep-grid-source-property-options');if(!g)return;if(cb.getValue()=='list'){g.show();}else{g.hide();}
this.syncSize();},scope:this}}},{xtype:'textfield',fieldLabel:_('lexicon'),name:'lexicon',id:'modx-cep-lexicon',anchor:'100%',allowBlank:true},{xtype:'modx-source-value-field',xtypeField:'modx-cep-xtype',id:'modx-cep-value',anchor:'100%'},{xtype:'modx-grid-source-property-options',id:'modx-cep-grid-source-property-options'}]});MODx.window.CreateSourceProperty.superclass.constructor.call(this,config);this.on('show',this.onShow,this);};Ext.extend(MODx.window.CreateSourceProperty,MODx.Window,{submit:function(){var v=this.fp.getForm().getValues();var g=Ext.getCmp('modx-cep-grid-source-property-options');var opt=eval(g.encode());Ext.apply(v,{options:opt});if(this.fp.getForm().isValid()){if(this.fireEvent('success',v)){this.fp.getForm().reset();this.hide();return true;}}
return false;},onShow:function(){var g=Ext.getCmp('modx-cep-grid-source-property-options');g.getStore().removeAll();g.hide();this.syncSize();this.center();}});Ext.reg('modx-window-source-property-create',MODx.window.CreateSourceProperty);MODx.window.UpdateSourceProperty=function(config){config=config||{};Ext.applyIf(config,{title:_('property_update'),id:'modx-window-source-property-update',saveBtnText:_('done'),forceLayout:true,fields:[{fieldLabel:_('name'),name:'name',id:'modx-uep-name',xtype:'textfield',anchor:'100%'},{fieldLabel:_('description'),name:'desc',id:'modx-uep-desc',xtype:'textarea',anchor:'100%'},{fieldLabel:_('type'),name:'xtype',xtype:'modx-combo-xtype',id:'modx-uep-xtype',anchor:'100%',listeners:{'select':{fn:function(cb,r,i){var g=Ext.getCmp('modx-uep-grid-source-property-options');if(!g)return;var v=cb.getValue();if(v=='list'){g.show();}else{g.hide();}
this.syncSize();},scope:this}}},{xtype:'textfield',fieldLabel:_('lexicon'),name:'lexicon',id:'modx-uep-lexicon',anchor:'100%',allowBlank:true},{xtype:'hidden',name:'overridden',id:'modx-uep-overridden'},{xtype:'modx-source-value-field',xtypeField:'modx-uep-xtype',name:'value',anchor:'100%',id:'modx-uep-value'},{id:'modx-uep-grid-source-property-options',xtype:'modx-grid-source-property-options',autoHeight:true}]});MODx.window.UpdateSourceProperty.superclass.constructor.call(this,config);this.on('show',this.onShow,this);};Ext.extend(MODx.window.UpdateSourceProperty,MODx.Window,{submit:function(){var v=this.fp.getForm().getValues();var g=Ext.getCmp('modx-uep-grid-source-property-options');var opt=eval(g.encode());Ext.apply(v,{options:opt});if(this.fp.getForm().isValid()){if(this.fireEvent('success',v)){this.fp.getForm().reset();this.hide();return true;}}
return false;},onShow:function(){var g=Ext.getCmp('modx-uep-grid-source-property-options');if(!g)return;if(this.fp.getForm().findField('xtype').getValue()=='list'){g.show();}else{g.hide();}
g.getStore().removeAll();var gp=Ext.getCmp('modx-grid-source-properties');var rec=gp.getSelectionModel().getSelected();if(rec){var opt=rec.data.options;var opts=[];for(var x in opt){if(opt.hasOwnProperty(x)){opts.push([opt[x].text,opt[x].value]);}}
g.getStore().loadData(opts);}
this.syncSize();this.center();}});Ext.reg('modx-window-source-property-update',MODx.window.UpdateSourceProperty);MODx.window.CreateSourcePropertyOption=function(config){config=config||{};Ext.applyIf(config,{title:_('property_option_create'),id:'modx-window-source-property-option-create',saveBtnText:_('done'),fields:[{fieldLabel:_('name'),name:'text',id:'modx-cepo-text',xtype:'textfield',anchor:'100%'},{fieldLabel:_('value'),name:'value',id:'modx-cepo-value',xtype:'textfield',anchor:'100%'}]});MODx.window.CreateSourcePropertyOption.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateSourcePropertyOption,MODx.Window,{submit:function(){if(this.fp.getForm().isValid()){if(this.fireEvent('success',this.fp.getForm().getValues())){this.fp.getForm().reset();this.hide();return true;}}
return false;}});Ext.reg('modx-window-source-property-option-create',MODx.window.CreateSourcePropertyOption);MODx.combo.xType=function(config){config=config||{};Ext.applyIf(config,{store:new Ext.data.SimpleStore({fields:['d','v'],data:[[_('textfield'),'textfield'],[_('textarea'),'textarea'],[_('yesno'),'combo-boolean'],[_('date'),'datefield'],[_('list'),'list'],[_('integer'),'numberfield']]}),displayField:'d',valueField:'v',mode:'local',name:'xtype',hiddenName:'xtype',triggerAction:'all',editable:false,selectOnFocus:false,value:'textfield'});MODx.combo.xType.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.xType,Ext.form.ComboBox);Ext.reg('modx-combo-xtype',MODx.combo.xType);MODx.form.SourceValueField=function(config){config=config||{};Ext.applyIf(config,{fieldLabel:_('value'),name:'value',xtype:'textfield',anchor:'100%'});MODx.form.SourceValueField.superclass.constructor.call(this,config);this.config=config;this.on('change',this.checkValue,this);};Ext.extend(MODx.form.SourceValueField,Ext.form.TextField,{checkValue:function(fld,nv,ov){var t=Ext.getCmp(this.config.xtypeField).getValue();var v=fld.getValue();if(t=='combo-boolean'){v=(v=='1'||v=='true'||v==1||v==true||v==_('yes')||v=='yes')?1:0;fld.setValue(v);}}});Ext.reg('modx-source-value-field',MODx.form.SourceValueField);;MODx.grid.MediaSourceAccess=function(config){config=config||{};Ext.applyIf(config,{id:'modx-grid-source-access',fields:['id','target','target_name','principal_class','principal','principal_name','authority','authority_name','policy','policy_name','context_key'],type:'modAccessMediaSource',paging:true,columns:[{header:_('user_group'),dataIndex:'principal_name',width:120},{header:_('minimum_role'),dataIndex:'authority_name',width:50},{header:_('policy'),dataIndex:'policy_name',width:175}],tbar:[{text:_('source_access_add'),cls:'primary-button',scope:this,handler:this.createAcl}]});MODx.grid.MediaSourceAccess.superclass.constructor.call(this,config);this.propRecord=Ext.data.Record.create(config.fields);};Ext.extend(MODx.grid.MediaSourceAccess,MODx.grid.LocalGrid,{combos:{},windows:{},createAcl:function(itm,e){var r={target:this.config.source,principal_class:'modUserGroup'};if(!this.windows.access_add){this.windows.access_add=MODx.load({xtype:'modx-window-source-access-create',record:r,listeners:{'success':{fn:function(vs){var rec=new this.propRecord(vs);this.getStore().add(rec);},scope:this}}});}
this.windows.access_add.fp.getForm().reset();this.windows.access_add.setValues(r);this.windows.access_add.show(e.target);},editAcl:function(itm,e){var r=this.menu.record;Ext.applyIf(r,{source:r.target,user_group:r.principal});if(!this.windows.update_acl){this.windows.update_acl=MODx.load({xtype:'modx-window-source-access-update',acl:r.id,record:r,listeners:{'success':{fn:function(vs){var s=this.getStore();var rec;try{rec=s.getAt(s.find('id',vs.id));}catch(e){}
if(rec){for(var k in vs){rec.set(k,vs[k]);}
rec.commit();}},scope:this}}});}
this.windows.update_acl.setValues(r);this.windows.update_acl.show(e.target);},removeAcl:function(itm,e){MODx.msg.confirm({title:_('source_access_remove'),text:_('source_access_remove_confirm'),url:this.config.url,params:{action:'security/access/removeAcl',id:this.menu.record.id,type:this.config.type||'modAccessMediaSource'},listeners:{'success':{fn:this.refresh,scope:this}}});},getMenu:function(){var menu=[];if(this.menu.record.id){menu.push({text:_('source_access_update'),handler:this.editAcl});}
menu.push({text:_('source_access_remove'),handler:this.remove.createDelegate(this,[{title:_('source_access_remove'),text:_('source_access_remove_confirm')}])});return menu;}});Ext.reg('modx-grid-source-access',MODx.grid.MediaSourceAccess);MODx.window.CreateSourceAccess=function(config){config=config||{};var r=config.record;Ext.applyIf(config,{title:_('source_access_add'),type:'modAccessMediaSource',acl:0,fields:[{xtype:'hidden',name:'id',value:r.id||''},{xtype:'hidden',name:'target',value:config.target||0},{xtype:'hidden',name:'principal_class',value:'modUserGroup'},{xtype:'hidden',name:'context_key',hiddenName:'context_key',value:'mgr'},{xtype:'modx-combo-usergroup',fieldLabel:_('user_group'),name:'principal',hiddenName:'principal',value:r.principal||'',baseParams:{action:'security/group/getList',combo:'1'},anchor:'100%'},{xtype:'modx-combo-authority',fieldLabel:_('minimum_role'),name:'authority',hiddenName:'authority',value:r.authority||9999,anchor:'100%'},{xtype:'modx-combo-policy',fieldLabel:_('policy'),name:'policy',hiddenName:'policy',value:r.policy||'',baseParams:{action:'security/access/policy/getList',group:'MediaSource'},anchor:'100%'}]});MODx.window.CreateSourceAccess.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateSourceAccess,MODx.Window,{submit:function(){var f=this.fp.getForm();var prf=f.findField('principal');var pof=f.findField('policy');var auf=f.findField('authority');var r=f.getValues();if(prf){r.principal_name=prf.getRawValue();}
if(pof){r.policy_name=pof.getRawValue();}
if(auf){r.authority_name=auf.getRawValue();}
if(this.fp.getForm().isValid()){if(this.fireEvent('success',r)){this.fp.getForm().reset();this.hide();return true;}}else{MODx.msg.alert(_('error'),_('user_err_ns'));}
return true;}});Ext.reg('modx-window-source-access-create',MODx.window.CreateSourceAccess);MODx.window.UpdateSourceAccess=function(config){config=config||{};var r=config.record;Ext.applyIf(config,{title:_('source_access_update')});MODx.window.UpdateSourceAccess.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateSourceAccess,MODx.window.CreateSourceAccess,{});Ext.reg('modx-window-source-access-update',MODx.window.UpdateSourceAccess);;MODx.panel.Source=function(config){config=config||{};Ext.applyIf(config,{id:'modx-panel-source',url:MODx.config.connector_url,baseParams:{action:'source/update'},defaults:{collapsible:false,autoHeight:true},cls:'container form-with-labels',items:[{html:'<h2>'+_('source')+'</h2>',border:false,cls:'modx-page-header',id:'modx-source-header'},{xtype:'modx-tabs',defaults:{autoHeight:true,border:true,bodyCssClass:'tab-panel-wrapper'},id:'modx-source-tabs',forceLayout:true,deferredRender:false,stateful:true,stateId:'modx-source-tabpanel',stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};},items:[{title:_('general_information'),defaults:{border:false,msgTarget:'side'},layout:'form',id:'modx-dashboard-form',labelWidth:150,items:[{xtype:'panel',border:false,cls:'main-wrapper',layout:'form',labelAlign:'top',items:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false},items:[{columnWidth:.65,cls:'main-content',items:[{xtype:'hidden',name:'id',id:'modx-source-id',value:config.record.id},{name:'name',id:'modx-source-name',xtype:'textfield',fieldLabel:_('name'),description:MODx.expandHelp?'':_('source_name_desc'),allowBlank:false,enableKeyEvents:true,anchor:'100%',listeners:{'keyup':{scope:this,fn:function(f,e){Ext.getCmp('modx-source-header').getEl().update('<h2>'+_('source')+': '+f.getValue()+'</h2>');}}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-source-name',html:_('source_name_desc'),cls:'desc-under'},{name:'description',id:'modx-source-description',xtype:'textarea',fieldLabel:_('description'),description:MODx.expandHelp?'':_('source_description_desc'),anchor:'100%',grow:true},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-source-description',html:_('source_description_desc'),cls:'desc-under'}]},{columnWidth:.35,cls:'main-content',items:[{name:'class_key',hiddenName:'class_key',id:'modx-source-type',xtype:'modx-combo-source-type',fieldLabel:_('source_type'),description:MODx.expandHelp?'':_('source_type_desc'),anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-source-type',html:_('source_type_desc'),cls:'desc-under'}]}]}]},{html:'<p>'+_('source_properties.intro_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-source-properties',preventRender:true,source:config.record.id,defaultProperties:config.defaultProperties,autoHeight:true,cls:'main-wrapper',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this}}}]},{title:_('access'),hideMode:'offsets',items:[{html:'<p>'+_('source.access.intro_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-source-access',preventRender:true,source:config.record.id,autoHeight:true,cls:'main-wrapper',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'updateRole':{fn:this.markDirty,scope:this},'addMember':{fn:this.markDirty,scope:this}}}]}]}],listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this}}});MODx.panel.Source.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.Source,MODx.FormPanel,{initialized:false,setup:function(){if(this.initialized){return false;}
if(Ext.isEmpty(this.config.record.id)){this.fireEvent('ready');return false;}
this.getForm().setValues(this.config.record);Ext.getCmp('modx-source-header').html='<h2>'+_('source')+': '+this.config.record.name+'</h2>';var g,d;if(!Ext.isEmpty(this.config.record.properties)){g=Ext.getCmp('modx-grid-source-properties');if(g){g.defaultProperties=this.config.defaultProperties;g.getStore().loadData(this.config.record.properties);}}
if(!Ext.isEmpty(this.config.record.access)){d=this.config.record.access;g=Ext.getCmp('modx-grid-source-access');if(g){d=Ext.decode(d);if(!Ext.isEmpty(d)){g.defaultProperties=d;g.getStore().loadData(d);}}}
this.fireEvent('ready',this.config.record);MODx.fireEvent('ready');this.initialized=true;},beforeSubmit:function(o){var bp={};var sp=Ext.getCmp('modx-grid-source-properties');if(sp){bp.properties=sp.encode();}
var ap=Ext.getCmp('modx-grid-source-access');if(ap){bp.access=ap.encode();}
Ext.apply(o.form.baseParams,bp);},success:function(o){if(Ext.isEmpty(this.config.record)||Ext.isEmpty(this.config.record.id)){MODx.loadPage('source/update','id='+o.result.object.id);}else{Ext.getCmp('modx-abtn-save').setDisabled(false);var wg=Ext.getCmp('modx-grid-source-properties');if(wg){wg.getStore().commitChanges();}
var ag=Ext.getCmp('modx-grid-source-access');if(ag){ag.getStore().commitChanges();}}}});Ext.reg('modx-panel-source',MODx.panel.Source);;MODx.page.UpdateSource=function(config){config=config||{};Ext.applyIf(config,{formpanel:'modx-panel-source',actions:{'new':'source/create',edit:'source/update',cancel:'source'},buttons:[{process:'source/update',text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]},{process:'cancel',text:_('cancel'),id:'modx-abtn-cancel',params:{a:'source'}},{text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane}],components:[{xtype:'modx-panel-source',record:config.record,defaultProperties:config.defaultProperties||[]}]});MODx.page.UpdateSource.superclass.constructor.call(this,config);};Ext.extend(MODx.page.UpdateSource,MODx.Component);Ext.reg('modx-page-source-update',MODx.page.UpdateSource);